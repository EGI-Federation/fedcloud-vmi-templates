- name: Create appliance directories
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "/etc/cloudkeeper"
    - "/etc/cloudkeeper-os"
    - "/etc/apel"
    - "/etc/caso"
    - "/etc/cloud-info-provider"
    - "/var/spool/caso"
    - "/var/spool/apel"
    - "/var/lock/cloudkeeper"
    - "/image_data"
    - "/etc/egi"

- name: Create defaults file
  template:
    src: defaults.j2
    dest: /etc/egi/defaults

- name: Copy configuration files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - src: cloudkeeper-os.service
      dest: /etc/systemd/system/cloudkeeper-os.service
    - src: sender.cfg
      dest: /etc/apel/sender.cfg
    - src: cloudkeeper-os.conf
      dest: /etc/cloudkeeper-os/cloudkeeper-os.conf
    - src: mapping.json
      dest: /etc/cloudkeeper-os/mapping.json
    - src: image-lists.conf
      dest: /etc/cloudkeeper/image-lists.conf
    - src: cloudkeeper.yml
      dest: /etc/cloudkeeper
    - src: voms.json
      dest: /etc/caso/voms.json
    - src: caso.conf
      dest: /etc/caso/caso.conf
    - src: openstack.rc
      dest: /etc/cloud-info-provider/openstack.rc
    - src: openstack.yaml
      dest: /etc/cloud-info-provider/openstack.yaml


- name: Copy scripts
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 0755
  with_items:
    - src: cloud-info.sh
      dest: /usr/local/bin/cloud-info.sh
    - src: cloudkeeper.sh
      dest: /usr/local/bin/cloudkeeper.sh
    - src: ssm-send.sh
      dest: /usr/local/bin/ssm-send.sh
    - src: caso-extract.sh
      dest: /usr/local/bin/caso-extract.sh

- name: cloudkeeper cron entry
  cron:
    name: cloudkeeper
    hour: "*/4"
    minute: 26
    job: "/usr/local/bin/cloudkeeper.sh >> /var/log/cloudkeeper.log 2>&1"

- name: SSM logging config file
  get_url:
    url: "https://github.com/apel/ssm/blob/{{ ssm_tag }}/conf/logging.cfg"
    dest: /etc/apel/logging.cfg

- name: SSM cron entry
  cron:
    name: ssm
    hour: "*/6"
    minute: 30
    job: "/usr/local/bin/ssm-send.sh >> /var/log/ssm.log 2>&1"

- name: caso cron entry
  cron:
    name: caso
    hour: "*/4"
    minute: 14
    job: "/usr/local/bin/caso-extract.sh >> /var/log/caso.log 2>&1"

- name: Enable services
  systemd:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - cloudkeeper-os

- name: add CAs repo key
  apt_key: url="https://dist.eugridpma.info/distribution/igtf/current/GPG-KEY-EUGridPMA-RPM-3"

- name: add CAs repo
  apt_repository:
    repo: 'deb http://repository.egi.eu/sw/production/cas/1/current egi-igtf core'
    state: present
    update_cache: yes

- name: Install CAs and fetch-crl
  apt:
    name: ["ca-policy-egi-core", "fetch-crl"]
    state: present

#  - name: pull docker images
#    command: docker pull "{{ item }}"
#    with_items:
#      - "egifedcloud/ops-cloudkeeper-core:{{ appliance_tag}}"
#      - "egifedcloud/ops-cloudkeeper-os:{{ appliance_tag}}"
#      - "egifedcloud/ops-cloud-info:{{ appliance_tag}}"
#      - "egifedcloud/ops-caso:{{ appliance_tag}}"
#      - "stfc/ssm:{{ ssm_tag }}"
