tosca_definitions_version: tosca_simple_yaml_1_0

description: 'Deploy a compute node getting the IP and SSH credentials to access via
  ssh with an extra HD disk.'

imports:
- grycap_custom_types: https://raw.githubusercontent.com/grycap/tosca/main/custom_types.yaml
metadata:
  childs: []
  filename: simple-node-disk.yml
  icon: images/vm-icon-disk.png
  infra_name: im-client
  order: 1
  tabs:
    GPU Data: .*gpu.*
    VM Data:
    - num_cpus
    - mem_size
    - disk_size
    - instance_type
    - num_instances
    - storage_size
    - mount_path
    - ports
  tag: VM
  template_author: Miguel Caballer
  template_name: VM
  template_version: 1.1.0
topology_template:
  inputs:
    disk_size:
      constraints:
      - valid_values:
        - 20 GB
        - 50 GB
        - 100 GB
        - 200 GB
        - 0 GB
      default: 200 GB
      description: Size of the root disk of the VM (in case of 0 disk will no be resized)
      type: scalar-unit.size
    gpu_model:
      default: ''
      description: GPU Model
      type: string
    gpu_vendor:
      constraints:
      - valid_values:
        - ''
        - NVIDIA
        - AMD
      default: ''
      description: GPU Vendor
      type: string
    instance_type:
      default: ''
      description: Flavor name of the instance
      type: string
    mem_size:
      constraints:
      - valid_values:
        - 2 GB
        - 4 GB
        - 8 GB
        - 16 GB
        - 32 GB
        - 64 GB
        - 128 GB
        - 256 GB
        - 512 GB
      default: 8 GB
      description: Amount of memory for the VM
      type: scalar-unit.size
    mount_path:
      default: /mnt/disk
      description: Path to mount the extra disk
      type: string
    num_cpus:
      constraints:
      - valid_values:
        - 1
        - 2
        - 4
        - 8
        - 16
        - 32
        - 64
      default: 4
      description: Number of virtual cpus for the VM
      type: integer
    num_gpus:
      constraints:
      - valid_values:
        - 0
        - 1
        - 2
        - 3
        - 4
      default: 0
      description: Number of GPUs to assing to this VM
      type: integer
    num_instances:
      default: 1
      description: Number of VMs to be spawned
      type: integer
    ports:
      default:
        port_22:
          protocol: tcp
          source: 22
      description: 'List of ports to be Opened in the Cloud site (eg. 22,80,443,2000:2100).
        You can also include the remote CIDR (eg. 8.8.0.0/24).
        '
      entry_schema:
        type: PortSpec
      type: map
    storage_size:
      constraints:
      - valid_values:
        - 0 GB
        - 10 GB
        - 20 GB
        - 50 GB
        - 100 GB
        - 200 GB
        - 500 GB
        - 1 TB
        - 2 TB
        - 10 TB
        - 20 TB
        - 40 TB
        - 100 TB
      default: 0 GB
      description: Size of the extra HD added to the instance (Set 0 if disk is not
        needed)
      type: scalar-unit.size
  node_templates:
    my_block_storage:
      properties:
        size:
          get_input: storage_size
      type: tosca.nodes.BlockStorage
    simple_node:
      capabilities:
        endpoint:
          properties:
            network_name: PUBLIC
            ports:
              get_input: ports
        host:
          properties:
            disk_size:
              get_input: disk_size
            gpu_model:
              get_input: gpu_model
            gpu_vendor:
              get_input: gpu_vendor
            instance_type:
              get_input: instance_type
            mem_size:
              get_input: mem_size
            num_cpus:
              get_input: num_cpus
            num_gpus:
              get_input: num_gpus
        os:
          properties:
            image: ost://bulut.truba.gov.tr/%IMAGE%
            type: linux
        scalable:
          properties:
            count:
              get_input: num_instances
      interfaces:
        Standard:
          configure:
            implementation: https://raw.githubusercontent.com/grycap/tosca/main/artifacts/dummy.yml
      properties:
        instance_name: im-client_simple_node
      requirements:
      - local_storage:
          capability: tosca.capabilities.Attachment
          node: my_block_storage
          relationship:
            properties:
              location:
                get_input: mount_path
            type: tosca.relationships.AttachesTo
      type: tosca.nodes.indigo.Compute
  outputs:
    node_creds:
      value:
        get_attribute:
        - simple_node
        - endpoint
        - credential
        - 0
    node_ip:
      value:
        get_attribute:
        - simple_node
        - public_address
        - 0
